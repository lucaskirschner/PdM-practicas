5. Interfaces digitales
El BMP280 es compatible con las interfaces digitales I2C y SPI; actúa como esclavo en ambos protocolos. La interfaz I2C admite los modos Estándar, Rápido y de Alta Velocidad. La interfaz SPI es compatible con los modos SPI ‘00’ (CPOL = CPHA = ‘0’) y ‘11’ (CPOL = CPHA = ‘1’), en configuraciones de 4 y 3 hilos.

Se admiten las siguientes transacciones:

Escritura de un solo byte

Escritura de múltiples bytes (utilizando pares de direcciones de registro y datos de registro)

Lectura de un solo byte

Lectura de múltiples bytes (usando una única dirección de registro con auto-incremento)

5.1 Selección de interfaz
La selección de la interfaz se realiza automáticamente según el estado de CSB (chip select). Si CSB está conectado a VDDIO, se activa la interfaz I2C. Si CSB se conecta a tierra, se activa la interfaz SPI.

Una vez que CSB ha sido llevado a tierra (independientemente de si ha ocurrido algún ciclo de reloj), la interfaz I2C queda deshabilitada hasta el próximo reinicio por encendido (power-on-reset). Esto evita que el tráfico SPI dirigido a otro esclavo sea interpretado erróneamente como datos I2C.

Dado que el reinicio por encendido solo se ejecuta cuando tanto VDD como VDDIO están presentes, no hay riesgo de una detección incorrecta del protocolo debido a la secuencia de encendido utilizada. Sin embargo, si se va a utilizar I2C y CSB no está conectado directamente a VDDIO, sino a través de un pin programable, es necesario asegurarse de que dicho pin ya esté en VDDIO durante el reinicio por encendido del dispositivo. Si esto no se cumple, el dispositivo quedará bloqueado en modo SPI y no responderá a comandos I2C.

5.3 Interfaz SPI
La interfaz SPI es compatible con el modo SPI ‘00’ (CPOL = CPHA = ‘0’) y el modo ‘11’ (CPOL = CPHA = ‘1’). La selección automática entre los modos ‘00’ y ‘11’ se determina según el valor de SCK después del flanco descendente de CSB.

La interfaz SPI tiene dos modos: 4 hilos y 3 hilos. El protocolo es el mismo en ambos casos. El modo de 3 hilos se activa configurando en ‘1’ el registro spi3w_en. En este modo, el pin SDI se utiliza como línea de datos.

Los pines utilizados en la interfaz SPI son los siguientes:

CSB: selección de chip, activo en bajo

SCK: reloj en serie

SDI: entrada de datos en serie; entrada/salida de datos en modo de 3 hilos

SDO: salida de datos en serie; en estado de alta impedancia (hi-Z) en modo de 3 hilos

Consulta el capítulo 6 para obtener instrucciones de conexión.

CSB es activo en bajo y cuenta con una resistencia pull-up integrada. Los datos en SDI son capturados por el dispositivo en el flanco ascendente de SCK, mientras que SDO cambia en el flanco descendente de SCK. La comunicación comienza cuando CSB pasa a bajo y finaliza cuando CSB vuelve a alto; durante estas transiciones de CSB, SCK debe permanecer estable.

El protocolo SPI se muestra en la Figura 9. Para detalles de temporización, consulta la Tabla 28.

En modo SPI, solo se utilizan 7 bits de las direcciones de registro; el bit más significativo (MSB) de la dirección del registro no se usa y se reemplaza por un bit de lectura/escritura (RW = ‘0’ para escritura y RW = ‘1’ para lectura).

Ejemplo: la dirección 0xF7 se accede mediante la dirección 0x77 en SPI. Para una escritura, se transfiere el byte 0x77, y para una lectura, se transfiere el byte 0xF7.

5.3.1 Escritura en SPI
La escritura se realiza bajando CSB y enviando pares de bytes de control y datos de registro.

Los bytes de control están compuestos por la dirección del registro SPI (dirección completa del registro sin el bit 7) y el comando de escritura (bit 7 = RW = ‘0’).

Se pueden escribir varios pares sin necesidad de subir CSB.

La transacción finaliza al subir CSB.

El protocolo de escritura SPI se muestra en la Figura 10.

5.3.2 Lectura en SPI
La lectura se realiza bajando CSB y enviando primero un byte de control.

Los bytes de control están compuestos por la dirección del registro SPI (dirección completa del registro sin el bit 7) y el comando de lectura (bit 7 = RW = ‘1’).

Luego de enviar el byte de control, los datos son transmitidos por el pin SDO (SDI en modo de 3 hilos).

La dirección del registro se incrementa automáticamente.

El protocolo de lectura SPI se muestra en la Figura 11.



